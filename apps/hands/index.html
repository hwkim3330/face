<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HandsPlay - ÏÜê Ïù∏Ïãù Ïù∏ÌÑ∞ÎûôÌã∞Î∏å Ïï±</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úã</text></svg>">
    <meta name="theme-color" content="#4facfe">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0c0c1e 0%, #1a1a3e 50%, #0d2137 100%);
            min-height: 100vh;
            overflow: hidden;
            color: #fff;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .header h1 {
            font-size: 1.3rem;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Camera */
        .camera-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }

        /* Loading */
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0c0c1e 0%, #1a1a3e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            transition: opacity 0.5s;
        }

        .loading-screen.hidden { opacity: 0; pointer-events: none; }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { margin-top: 20px; color: rgba(255,255,255,0.8); }

        /* Hand Info */
        .hand-info {
            position: absolute;
            top: 60px;
            left: 15px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            z-index: 50;
        }

        .hand-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }

        .gesture-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4facfe;
        }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
        }

        .mode-tab {
            background: none;
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 10px 18px;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .mode-tab.active {
            color: #fff;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        /* Virtual Piano */
        .piano-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            display: none;
            background: rgba(0,0,0,0.8);
            z-index: 60;
        }

        .piano-container.active { display: flex; }

        .piano-key {
            flex: 1;
            background: linear-gradient(180deg, #fff 0%, #e0e0e0 100%);
            margin: 0 2px;
            border-radius: 0 0 8px 8px;
            transition: all 0.1s;
            position: relative;
        }

        .piano-key.black {
            background: linear-gradient(180deg, #333 0%, #111 100%);
            position: absolute;
            width: 8%;
            height: 60%;
            z-index: 1;
        }

        .piano-key.active {
            background: linear-gradient(180deg, #4facfe, #00f2fe);
            transform: scaleY(0.98);
        }

        .piano-key .note {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: #333;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Drawing Canvas */
        #drawCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 55;
        }

        /* Drawing Tools */
        .draw-tools {
            position: absolute;
            top: 60px;
            right: 15px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 70;
        }

        .draw-tools.active { display: flex; }

        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #fff;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-btn.active { transform: scale(1.2); }

        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Game UI */
        .game-ui {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: none;
            z-index: 70;
        }

        .game-ui.active { display: block; }

        .game-countdown {
            font-size: 5rem;
            font-weight: bold;
            text-shadow: 0 0 30px rgba(79, 172, 254, 0.8);
        }

        .game-result {
            font-size: 2rem;
            margin-top: 20px;
        }

        .game-opponent {
            font-size: 8rem;
            margin: 20px 0;
            animation: bounce 0.5s ease-out;
        }

        @keyframes bounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .game-score-display {
            position: absolute;
            top: 60px;
            right: 15px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px;
            z-index: 70;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            font-size: 1.1rem;
        }

        /* Bottom Bar */
        .bottom-bar {
            padding: 15px;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .action-btn {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: #fff;
        }

        .action-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(50px);
            background: rgba(0,0,0,0.8);
            padding: 12px 24px;
            border-radius: 25px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 500;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Gesture Guide */
        .gesture-guide {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 15px;
            display: flex;
            gap: 20px;
            z-index: 60;
        }

        .gesture-item {
            text-align: center;
        }

        .gesture-item .emoji { font-size: 2rem; }
        .gesture-item .name { font-size: 0.75rem; margin-top: 5px; color: rgba(255,255,255,0.7); }

        @media (max-width: 500px) {
            .gesture-guide { gap: 12px; padding: 12px 15px; }
            .gesture-item .emoji { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Loading -->
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-spinner"></div>
            <div class="loading-text">ÏÜê Ïù∏Ïãù Î™®Îç∏ Î°úÎî© Ï§ë...</div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <a href="../../" class="back-btn">‚Üê</a>
                <h1>‚úã HandsPlay</h1>
            </div>
        </div>

        <!-- Mode Tabs -->
        <div class="mode-tabs">
            <button class="mode-tab active" data-mode="gesture">Ï†úÏä§Ï≤ò</button>
            <button class="mode-tab" data-mode="piano">ÌîºÏïÑÎÖ∏</button>
            <button class="mode-tab" data-mode="draw">Í∑∏Î¶¨Í∏∞</button>
            <button class="mode-tab" data-mode="game">Í∞ÄÏúÑÎ∞îÏúÑÎ≥¥</button>
        </div>

        <!-- Camera -->
        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <canvas id="drawCanvas"></canvas>

            <!-- Hand Info -->
            <div class="hand-info" id="handInfo">
                <div class="hand-info-item">
                    <span>üñêÔ∏è</span>
                    <span id="handCount">ÏÜê: 0Í∞ú</span>
                </div>
                <div class="hand-info-item">
                    <span>üëÜ</span>
                    <span class="gesture-name" id="gestureName">-</span>
                </div>
            </div>

            <!-- Gesture Guide -->
            <div class="gesture-guide" id="gestureGuide">
                <div class="gesture-item"><span class="emoji">‚úä</span><span class="name">Ï£ºÎ®π</span></div>
                <div class="gesture-item"><span class="emoji">‚úåÔ∏è</span><span class="name">Í∞ÄÏúÑ</span></div>
                <div class="gesture-item"><span class="emoji">üñêÔ∏è</span><span class="name">Î≥¥</span></div>
                <div class="gesture-item"><span class="emoji">üëÜ</span><span class="name">Í≤ÄÏßÄ</span></div>
                <div class="gesture-item"><span class="emoji">üëç</span><span class="name">ÏóÑÏßÄÏ≤ô</span></div>
                <div class="gesture-item"><span class="emoji">ü§ü</span><span class="name">ÏÇ¨ÎûëÌï¥</span></div>
            </div>

            <!-- Piano -->
            <div class="piano-container" id="pianoContainer">
                <!-- Piano keys generated by JS -->
            </div>

            <!-- Drawing Tools -->
            <div class="draw-tools" id="drawTools">
                <button class="color-btn active" data-color="#ff6b6b" style="background:#ff6b6b"></button>
                <button class="color-btn" data-color="#4facfe" style="background:#4facfe"></button>
                <button class="color-btn" data-color="#43e97b" style="background:#43e97b"></button>
                <button class="color-btn" data-color="#feca57" style="background:#feca57"></button>
                <button class="color-btn" data-color="#fff" style="background:#fff"></button>
                <button class="tool-btn" id="clearCanvas">üóëÔ∏è</button>
                <button class="tool-btn" id="saveDrawing">üíæ</button>
            </div>

            <!-- Game UI -->
            <div class="game-ui" id="gameUI">
                <div class="game-countdown" id="gameCountdown"></div>
                <div class="game-opponent" id="gameOpponent"></div>
                <div class="game-result" id="gameResult"></div>
            </div>

            <div class="game-score-display" id="gameScoreDisplay" style="display:none">
                <div class="score-item"><span>ÎÇò</span><span id="myScore">0</span></div>
                <div class="score-item"><span>Ïª¥Ìì®ÌÑ∞</span><span id="cpuScore">0</span></div>
            </div>
        </div>

        <!-- Bottom Bar -->
        <div class="bottom-bar">
            <button class="action-btn primary" id="actionBtn">
                <span>üì∏</span> Ï∫°Ï≤ò
            </button>
            <button class="action-btn secondary" id="startGame" style="display:none">
                <span>üéÆ</span> Í≤åÏûÑ ÏãúÏûë
            </button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js"></script>

    <script>
        class HandsPlayApp {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.drawCanvas = document.getElementById('drawCanvas');
                this.drawCtx = this.drawCanvas.getContext('2d');

                this.hands = null;
                this.currentMode = 'gesture';
                this.currentGesture = null;
                this.lastDrawPoint = null;
                this.drawColor = '#ff6b6b';
                this.isDrawing = false;

                // Game state
                this.gameActive = false;
                this.myScore = 0;
                this.cpuScore = 0;

                // Piano
                this.audioContext = null;
                this.activeNotes = new Set();

                this.init();
            }

            async init() {
                try {
                    await this.initHands();
                    await this.initCamera();
                    this.initUI();
                    this.initPiano();
                    this.initAudio();
                    document.getElementById('loadingScreen').classList.add('hidden');
                } catch (error) {
                    console.error('Init error:', error);
                    alert('Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ' + error.message);
                }
            }

            async initHands() {
                this.hands = new Hands({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`
                });

                this.hands.setOptions({
                    maxNumHands: 2,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.7,
                    minTrackingConfidence: 0.5
                });

                this.hands.onResults((results) => this.onResults(results));
            }

            async initCamera() {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 1280, height: 720 }
                });
                this.video.srcObject = stream;

                return new Promise((resolve) => {
                    this.video.onloadedmetadata = () => {
                        this.video.play();
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        this.drawCanvas.width = this.video.videoWidth;
                        this.drawCanvas.height = this.video.videoHeight;
                        this.startProcessing();
                        resolve();
                    };
                });
            }

            startProcessing() {
                const process = async () => {
                    if (this.video.readyState >= 2) {
                        await this.hands.send({ image: this.video });
                    }
                    requestAnimationFrame(process);
                };
                process();
            }

            initAudio() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            initPiano() {
                const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B', 'C2'];
                const frequencies = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];
                const container = document.getElementById('pianoContainer');

                notes.forEach((note, i) => {
                    const key = document.createElement('div');
                    key.className = 'piano-key';
                    key.dataset.note = note;
                    key.dataset.freq = frequencies[i];
                    key.innerHTML = `<span class="note">${note}</span>`;
                    container.appendChild(key);
                });

                this.pianoKeys = container.querySelectorAll('.piano-key');
            }

            onResults(results) {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    document.getElementById('handCount').textContent = `ÏÜê: ${results.multiHandLandmarks.length}Í∞ú`;

                    results.multiHandLandmarks.forEach((landmarks, idx) => {
                        // Draw hand skeleton
                        this.drawHandSkeleton(landmarks, results.multiHandedness[idx]);

                        // Detect gesture
                        const gesture = this.detectGesture(landmarks);
                        this.currentGesture = gesture;
                        document.getElementById('gestureName').textContent = gesture;

                        // Mode-specific processing
                        if (this.currentMode === 'piano') {
                            this.handlePiano(landmarks);
                        } else if (this.currentMode === 'draw') {
                            this.handleDrawing(landmarks, gesture);
                        } else if (this.currentMode === 'game' && this.gameActive) {
                            // Game handles gesture separately
                        }
                    });
                } else {
                    document.getElementById('handCount').textContent = 'ÏÜê: 0Í∞ú';
                    document.getElementById('gestureName').textContent = '-';
                    this.lastDrawPoint = null;
                    this.resetPianoKeys();
                }
            }

            drawHandSkeleton(landmarks, handedness) {
                const w = this.canvas.width;
                const h = this.canvas.height;
                const color = handedness.label === 'Left' ? '#4facfe' : '#43e97b';

                // Connections
                const connections = [
                    [0,1],[1,2],[2,3],[3,4], // thumb
                    [0,5],[5,6],[6,7],[7,8], // index
                    [0,9],[9,10],[10,11],[11,12], // middle
                    [0,13],[13,14],[14,15],[15,16], // ring
                    [0,17],[17,18],[18,19],[19,20], // pinky
                    [5,9],[9,13],[13,17] // palm
                ];

                this.ctx.strokeStyle = color;
                this.ctx.lineWidth = 3;

                connections.forEach(([start, end]) => {
                    const p1 = landmarks[start];
                    const p2 = landmarks[end];
                    this.ctx.beginPath();
                    this.ctx.moveTo(p1.x * w, p1.y * h);
                    this.ctx.lineTo(p2.x * w, p2.y * h);
                    this.ctx.stroke();
                });

                // Landmarks
                landmarks.forEach((landmark, i) => {
                    this.ctx.fillStyle = [4,8,12,16,20].includes(i) ? '#ff6b6b' : color;
                    this.ctx.beginPath();
                    this.ctx.arc(landmark.x * w, landmark.y * h, 6, 0, Math.PI * 2);
                    this.ctx.fill();
                });
            }

            detectGesture(landmarks) {
                const dominated = this.getFingerStates(landmarks);

                // Rock (Ï£ºÎ®π)
                if (!dominated.thumb && !dominated.index && !dominated.middle && !dominated.ring && !dominated.pinky) {
                    return '‚úä Ï£ºÎ®π';
                }

                // Scissors (Í∞ÄÏúÑ)
                if (!dominated.thumb && dominated.index && dominated.middle && !dominated.ring && !dominated.pinky) {
                    return '‚úåÔ∏è Í∞ÄÏúÑ';
                }

                // Paper (Î≥¥)
                if (dominated.thumb && dominated.index && dominated.middle && dominated.ring && dominated.pinky) {
                    return 'üñêÔ∏è Î≥¥';
                }

                // Pointing (Í≤ÄÏßÄ)
                if (!dominated.thumb && dominated.index && !dominated.middle && !dominated.ring && !dominated.pinky) {
                    return 'üëÜ Í≤ÄÏßÄ';
                }

                // Thumbs up
                if (dominated.thumb && !dominated.index && !dominated.middle && !dominated.ring && !dominated.pinky) {
                    return 'üëç ÏóÑÏßÄÏ≤ô';
                }

                // I love you
                if (dominated.thumb && dominated.index && !dominated.middle && !dominated.ring && dominated.pinky) {
                    return 'ü§ü ÏÇ¨ÎûëÌï¥';
                }

                // OK sign
                if (this.isOKSign(landmarks)) {
                    return 'üëå Ïò§ÏºÄÏù¥';
                }

                return 'üñêÔ∏è -';
            }

            getFingerStates(landmarks) {
                // Check if each finger is extended
                const isExtended = (tip, pip, mcp) => {
                    return landmarks[tip].y < landmarks[pip].y && landmarks[pip].y < landmarks[mcp].y;
                };

                // Thumb: compare x positions (different logic)
                const thumbExtended = Math.abs(landmarks[4].x - landmarks[2].x) > 0.05;

                return {
                    thumb: thumbExtended,
                    index: isExtended(8, 6, 5),
                    middle: isExtended(12, 10, 9),
                    ring: isExtended(16, 14, 13),
                    pinky: isExtended(20, 18, 17)
                };
            }

            isOKSign(landmarks) {
                const thumbTip = landmarks[4];
                const indexTip = landmarks[8];
                const dist = Math.sqrt(
                    Math.pow(thumbTip.x - indexTip.x, 2) +
                    Math.pow(thumbTip.y - indexTip.y, 2)
                );
                return dist < 0.05;
            }

            handlePiano(landmarks) {
                const w = this.canvas.width;
                const h = this.canvas.height;
                const indexTip = landmarks[8];
                const indexY = indexTip.y * h;
                const indexX = indexTip.x * w;

                // Reset all keys first
                this.pianoKeys.forEach(key => key.classList.remove('active'));

                // Check if finger is in piano area (bottom 30% of screen)
                if (indexY > h * 0.7) {
                    // Find which key
                    const keyIndex = Math.floor((indexX / w) * this.pianoKeys.length);
                    if (keyIndex >= 0 && keyIndex < this.pianoKeys.length) {
                        const key = this.pianoKeys[keyIndex];
                        key.classList.add('active');

                        const note = key.dataset.note;
                        if (!this.activeNotes.has(note)) {
                            this.activeNotes.add(note);
                            this.playNote(parseFloat(key.dataset.freq));
                        }
                    }
                } else {
                    this.activeNotes.clear();
                }
            }

            playNote(freq) {
                if (!this.audioContext) return;

                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();

                osc.type = 'sine';
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.5, this.audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);

                osc.connect(gain);
                gain.connect(this.audioContext.destination);

                osc.start();
                osc.stop(this.audioContext.currentTime + 0.5);
            }

            resetPianoKeys() {
                this.pianoKeys?.forEach(key => key.classList.remove('active'));
                this.activeNotes.clear();
            }

            handleDrawing(landmarks, gesture) {
                const w = this.drawCanvas.width;
                const h = this.drawCanvas.height;
                const indexTip = landmarks[8];
                const x = indexTip.x * w;
                const y = indexTip.y * h;

                // Only draw when index finger is up
                if (gesture.includes('Í≤ÄÏßÄ') || gesture.includes('Í∞ÄÏúÑ')) {
                    if (this.lastDrawPoint) {
                        this.drawCtx.strokeStyle = this.drawColor;
                        this.drawCtx.lineWidth = 8;
                        this.drawCtx.lineCap = 'round';
                        this.drawCtx.beginPath();
                        this.drawCtx.moveTo(this.lastDrawPoint.x, this.lastDrawPoint.y);
                        this.drawCtx.lineTo(x, y);
                        this.drawCtx.stroke();
                    }
                    this.lastDrawPoint = { x, y };
                } else if (gesture.includes('Ï£ºÎ®π')) {
                    // Fist = pause drawing
                    this.lastDrawPoint = null;
                } else {
                    this.lastDrawPoint = null;
                }
            }

            startRPSGame() {
                this.gameActive = true;
                document.getElementById('gameUI').classList.add('active');
                document.getElementById('gameScoreDisplay').style.display = 'block';
                document.getElementById('gestureGuide').style.display = 'none';

                let countdown = 3;
                const countdownEl = document.getElementById('gameCountdown');
                const opponentEl = document.getElementById('gameOpponent');
                const resultEl = document.getElementById('gameResult');

                opponentEl.textContent = '';
                resultEl.textContent = '';

                const interval = setInterval(() => {
                    countdownEl.textContent = countdown;
                    countdown--;

                    if (countdown < 0) {
                        clearInterval(interval);
                        countdownEl.textContent = 'ÎÇ¥!';

                        setTimeout(() => {
                            // Get player's gesture
                            let playerChoice = null;
                            if (this.currentGesture?.includes('Ï£ºÎ®π')) playerChoice = 'rock';
                            else if (this.currentGesture?.includes('Í∞ÄÏúÑ')) playerChoice = 'scissors';
                            else if (this.currentGesture?.includes('Î≥¥')) playerChoice = 'paper';

                            // CPU choice
                            const choices = ['rock', 'scissors', 'paper'];
                            const cpuChoice = choices[Math.floor(Math.random() * 3)];
                            const cpuEmoji = cpuChoice === 'rock' ? '‚úä' : cpuChoice === 'scissors' ? '‚úåÔ∏è' : 'üñêÔ∏è';

                            opponentEl.textContent = cpuEmoji;

                            // Determine winner
                            let result = '';
                            if (!playerChoice) {
                                result = '‚ùå Ïù∏Ïãù Ïã§Ìå®!';
                            } else if (playerChoice === cpuChoice) {
                                result = 'ü§ù Î¨¥ÏäπÎ∂Ä!';
                            } else if (
                                (playerChoice === 'rock' && cpuChoice === 'scissors') ||
                                (playerChoice === 'scissors' && cpuChoice === 'paper') ||
                                (playerChoice === 'paper' && cpuChoice === 'rock')
                            ) {
                                result = 'üéâ ÏäπÎ¶¨!';
                                this.myScore++;
                            } else {
                                result = 'üò¢ Ìå®Î∞∞!';
                                this.cpuScore++;
                            }

                            resultEl.textContent = result;
                            document.getElementById('myScore').textContent = this.myScore;
                            document.getElementById('cpuScore').textContent = this.cpuScore;

                            setTimeout(() => {
                                countdownEl.textContent = '';
                                this.gameActive = false;
                            }, 2000);
                        }, 500);
                    }
                }, 1000);
            }

            initUI() {
                // Mode tabs
                document.querySelectorAll('.mode-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.currentMode = tab.dataset.mode;

                        // Toggle UI elements
                        document.getElementById('pianoContainer').classList.toggle('active', this.currentMode === 'piano');
                        document.getElementById('drawTools').classList.toggle('active', this.currentMode === 'draw');
                        document.getElementById('startGame').style.display = this.currentMode === 'game' ? 'flex' : 'none';
                        document.getElementById('gestureGuide').style.display = this.currentMode === 'game' ? 'none' : 'flex';
                        document.getElementById('gameScoreDisplay').style.display = this.currentMode === 'game' ? 'block' : 'none';
                        document.getElementById('gameUI').classList.remove('active');
                    });
                });

                // Drawing colors
                document.querySelectorAll('.color-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.drawColor = btn.dataset.color;
                    });
                });

                // Clear canvas
                document.getElementById('clearCanvas').addEventListener('click', () => {
                    this.drawCtx.clearRect(0, 0, this.drawCanvas.width, this.drawCanvas.height);
                    this.showToast('Ï∫îÎ≤ÑÏä§ ÏßÄÏõÄ!');
                });

                // Save drawing
                document.getElementById('saveDrawing').addEventListener('click', () => {
                    const link = document.createElement('a');
                    link.download = `handsplay_drawing_${Date.now()}.png`;
                    link.href = this.drawCanvas.toDataURL();
                    link.click();
                    this.showToast('Í∑∏Î¶º Ï†ÄÏû•Îê®!');
                });

                // Capture
                document.getElementById('actionBtn').addEventListener('click', () => {
                    this.capturePhoto();
                });

                // Start game
                document.getElementById('startGame').addEventListener('click', () => {
                    this.startRPSGame();
                });
            }

            capturePhoto() {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = this.canvas.width;
                tempCanvas.height = this.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');

                // Draw video (flipped)
                tempCtx.save();
                tempCtx.scale(-1, 1);
                tempCtx.drawImage(this.video, -tempCanvas.width, 0);
                tempCtx.restore();

                // Draw skeleton (flipped)
                tempCtx.save();
                tempCtx.scale(-1, 1);
                tempCtx.drawImage(this.canvas, -tempCanvas.width, 0);
                tempCtx.restore();

                // Draw drawing canvas (flipped)
                tempCtx.save();
                tempCtx.scale(-1, 1);
                tempCtx.drawImage(this.drawCanvas, -tempCanvas.width, 0);
                tempCtx.restore();

                const link = document.createElement('a');
                link.download = `handsplay_${Date.now()}.png`;
                link.href = tempCanvas.toDataURL();
                link.click();

                this.showToast('üì∏ ÏÇ¨ÏßÑ Ï†ÄÏû•Îê®!');
            }

            showToast(msg) {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => new HandsPlayApp());
    </script>
</body>
</html>
