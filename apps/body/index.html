<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BodyPlay - Ï†ÑÏã† ÏûêÏÑ∏ Ïù∏Ïãù Ïï±</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèÉ</text></svg>">
    <meta name="theme-color" content="#43e97b">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1a2a4a 50%, #0d2030 100%);
            min-height: 100vh;
            overflow: hidden;
            color: #fff;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .header h1 {
            font-size: 1.3rem;
            background: linear-gradient(45deg, #43e97b, #38f9d7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Camera */
        .camera-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }

        /* Loading */
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1628 0%, #1a2a4a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            transition: opacity 0.5s;
        }

        .loading-screen.hidden { opacity: 0; pointer-events: none; }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #43e97b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { margin-top: 20px; color: rgba(255,255,255,0.8); }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
        }

        .mode-tab {
            background: none;
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 10px 18px;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .mode-tab.active {
            color: #fff;
            background: linear-gradient(135deg, #43e97b, #38f9d7);
        }

        /* Pose Info Panel */
        .pose-info {
            position: absolute;
            top: 60px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px;
            z-index: 50;
            min-width: 180px;
        }

        .pose-info h3 {
            font-size: 0.85rem;
            color: #43e97b;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .pose-stat {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .pose-stat .value {
            font-weight: bold;
            color: #43e97b;
        }

        /* Exercise Counter */
        .exercise-counter {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            text-align: center;
            z-index: 50;
        }

        .counter-value {
            font-size: 5rem;
            font-weight: bold;
            color: #43e97b;
            text-shadow: 0 0 30px rgba(67, 233, 123, 0.5);
        }

        .counter-label {
            font-size: 1rem;
            color: rgba(255,255,255,0.7);
        }

        .exercise-state {
            margin-top: 10px;
            padding: 8px 20px;
            background: rgba(67, 233, 123, 0.2);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        /* Pose Guide */
        .pose-guide {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 15px;
            text-align: center;
            z-index: 60;
        }

        .pose-guide h4 {
            color: #43e97b;
            margin-bottom: 8px;
        }

        .pose-guide p {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
        }

        /* Dance Game */
        .dance-targets {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 55;
        }

        .dance-target {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 4px solid #43e97b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            animation: targetPulse 1s ease-in-out infinite;
        }

        .dance-target.hit {
            background: rgba(67, 233, 123, 0.5);
            animation: targetHit 0.3s ease-out;
        }

        @keyframes targetPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        @keyframes targetHit {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); opacity: 0; }
        }

        /* Score Display */
        .score-display {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 15px;
            z-index: 60;
            text-align: center;
        }

        .score-display .score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #43e97b;
        }

        .score-display .label {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
        }

        .combo {
            margin-top: 10px;
            font-size: 1.2rem;
            color: #feca57;
        }

        /* Angle Indicator */
        .angle-indicator {
            position: absolute;
            background: rgba(0,0,0,0.8);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            color: #43e97b;
            pointer-events: none;
            z-index: 56;
        }

        /* Bottom Bar */
        .bottom-bar {
            padding: 15px;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .action-btn {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            color: #fff;
        }

        .action-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        /* Exercise Selector */
        .exercise-selector {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 60;
        }

        .exercise-btn {
            padding: 12px 20px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 15px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .exercise-btn.active {
            border-color: #43e97b;
            background: rgba(67, 233, 123, 0.2);
        }

        .exercise-btn .emoji { font-size: 1.5rem; display: block; margin-bottom: 5px; }
        .exercise-btn .name { font-size: 0.8rem; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(50px);
            background: rgba(0,0,0,0.8);
            padding: 12px 24px;
            border-radius: 25px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 500;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        @media (max-width: 600px) {
            .exercise-selector { flex-wrap: wrap; width: 90%; justify-content: center; }
            .counter-value { font-size: 3.5rem; }
            .pose-info { padding: 12px 15px; min-width: 150px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Loading -->
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-spinner"></div>
            <div class="loading-text">ÏûêÏÑ∏ Ïù∏Ïãù Î™®Îç∏ Î°úÎî© Ï§ë...</div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <a href="../../" class="back-btn">‚Üê</a>
                <h1>üèÉ BodyPlay</h1>
            </div>
        </div>

        <!-- Mode Tabs -->
        <div class="mode-tabs">
            <button class="mode-tab active" data-mode="analyze">ÏûêÏÑ∏ Î∂ÑÏÑù</button>
            <button class="mode-tab" data-mode="exercise">Ïö¥Îèô Ïπ¥Ïö¥ÌÑ∞</button>
            <button class="mode-tab" data-mode="dance">ÎåÑÏä§ Í≤åÏûÑ</button>
        </div>

        <!-- Camera -->
        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>

            <!-- Pose Info (Analyze Mode) -->
            <div class="pose-info" id="poseInfo">
                <h3>ÏûêÏÑ∏ Î∂ÑÏÑù</h3>
                <div class="pose-stat">
                    <span>ÏôºÏ™Ω ÌåîÍøàÏπò</span>
                    <span class="value" id="leftElbowAngle">-¬∞</span>
                </div>
                <div class="pose-stat">
                    <span>Ïò§Î•∏Ï™Ω ÌåîÍøàÏπò</span>
                    <span class="value" id="rightElbowAngle">-¬∞</span>
                </div>
                <div class="pose-stat">
                    <span>ÏôºÏ™Ω Î¨¥Î¶é</span>
                    <span class="value" id="leftKneeAngle">-¬∞</span>
                </div>
                <div class="pose-stat">
                    <span>Ïò§Î•∏Ï™Ω Î¨¥Î¶é</span>
                    <span class="value" id="rightKneeAngle">-¬∞</span>
                </div>
                <div class="pose-stat">
                    <span>Ïñ¥Íπ® Í∏∞Ïö∏Í∏∞</span>
                    <span class="value" id="shoulderTilt">-¬∞</span>
                </div>
            </div>

            <!-- Exercise Counter -->
            <div class="exercise-counter" id="exerciseCounter" style="display:none">
                <div class="counter-value" id="repCount">0</div>
                <div class="counter-label" id="exerciseName">Ïä§ÏøºÌä∏</div>
                <div class="exercise-state" id="exerciseState">Ï§ÄÎπÑ</div>
            </div>

            <!-- Exercise Selector -->
            <div class="exercise-selector" id="exerciseSelector" style="display:none">
                <button class="exercise-btn active" data-exercise="squat">
                    <span class="emoji">üèãÔ∏è</span>
                    <span class="name">Ïä§ÏøºÌä∏</span>
                </button>
                <button class="exercise-btn" data-exercise="pushup">
                    <span class="emoji">üí™</span>
                    <span class="name">ÌåîÍµΩÌòÄÌé¥Í∏∞</span>
                </button>
                <button class="exercise-btn" data-exercise="jumpingjack">
                    <span class="emoji">‚≠ê</span>
                    <span class="name">Ï†êÌïëÏû≠</span>
                </button>
                <button class="exercise-btn" data-exercise="lunge">
                    <span class="emoji">ü¶µ</span>
                    <span class="name">Îü∞ÏßÄ</span>
                </button>
            </div>

            <!-- Dance Game -->
            <div class="dance-targets" id="danceTargets"></div>

            <div class="score-display" id="scoreDisplay" style="display:none">
                <div class="label">Ï†êÏàò</div>
                <div class="score" id="danceScore">0</div>
                <div class="combo" id="comboDisplay"></div>
            </div>

            <!-- Pose Guide -->
            <div class="pose-guide" id="poseGuide" style="display:none">
                <h4 id="guideTitle">Ïä§ÏøºÌä∏</h4>
                <p id="guideText">Î¨¥Î¶éÏùÑ Íµ¨Î∂ÄÎ†§ ÏïâÏïòÎã§ ÏùºÏñ¥ÎÇòÏÑ∏Ïöî</p>
            </div>
        </div>

        <!-- Bottom Bar -->
        <div class="bottom-bar">
            <button class="action-btn primary" id="actionBtn">
                <span>üì∏</span> Ï∫°Ï≤ò
            </button>
            <button class="action-btn secondary" id="resetBtn">
                <span>üîÑ</span> Î¶¨ÏÖã
            </button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- MediaPipe Pose -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js"></script>

    <script>
        class BodyPlayApp {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');

                this.pose = null;
                this.currentMode = 'analyze';

                // Exercise tracking
                this.currentExercise = 'squat';
                this.repCount = 0;
                this.exerciseState = 'up'; // 'up' or 'down'

                // Dance game
                this.danceScore = 0;
                this.combo = 0;
                this.danceTargets = [];
                this.danceInterval = null;

                this.init();
            }

            async init() {
                try {
                    await this.initPose();
                    await this.initCamera();
                    this.initUI();
                    document.getElementById('loadingScreen').classList.add('hidden');
                } catch (error) {
                    console.error('Init error:', error);
                    alert('Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ' + error.message);
                }
            }

            async initPose() {
                this.pose = new Pose({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`
                });

                this.pose.setOptions({
                    modelComplexity: 1,
                    smoothLandmarks: true,
                    enableSegmentation: false,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                this.pose.onResults((results) => this.onResults(results));
            }

            async initCamera() {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 1280, height: 720 }
                });
                this.video.srcObject = stream;

                return new Promise((resolve) => {
                    this.video.onloadedmetadata = () => {
                        this.video.play();
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        this.startProcessing();
                        resolve();
                    };
                });
            }

            startProcessing() {
                const process = async () => {
                    if (this.video.readyState >= 2) {
                        await this.pose.send({ image: this.video });
                    }
                    requestAnimationFrame(process);
                };
                process();
            }

            onResults(results) {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                if (results.poseLandmarks) {
                    this.drawSkeleton(results.poseLandmarks);

                    if (this.currentMode === 'analyze') {
                        this.analyzePose(results.poseLandmarks);
                    } else if (this.currentMode === 'exercise') {
                        this.trackExercise(results.poseLandmarks);
                    } else if (this.currentMode === 'dance') {
                        this.updateDanceGame(results.poseLandmarks);
                    }
                }
            }

            drawSkeleton(landmarks) {
                const w = this.canvas.width;
                const h = this.canvas.height;

                // Connections
                const connections = [
                    [11, 13], [13, 15], // Left arm
                    [12, 14], [14, 16], // Right arm
                    [11, 12], // Shoulders
                    [11, 23], [12, 24], // Torso
                    [23, 24], // Hips
                    [23, 25], [25, 27], // Left leg
                    [24, 26], [26, 28], // Right leg
                    [15, 17], [15, 19], [15, 21], // Left hand
                    [16, 18], [16, 20], [16, 22], // Right hand
                    [27, 29], [27, 31], // Left foot
                    [28, 30], [28, 32]  // Right foot
                ];

                // Draw connections
                this.ctx.strokeStyle = '#43e97b';
                this.ctx.lineWidth = 4;

                connections.forEach(([start, end]) => {
                    const p1 = landmarks[start];
                    const p2 = landmarks[end];
                    if (p1.visibility > 0.5 && p2.visibility > 0.5) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(p1.x * w, p1.y * h);
                        this.ctx.lineTo(p2.x * w, p2.y * h);
                        this.ctx.stroke();
                    }
                });

                // Draw landmarks
                landmarks.forEach((landmark, i) => {
                    if (landmark.visibility > 0.5) {
                        const isJoint = [11,12,13,14,15,16,23,24,25,26,27,28].includes(i);
                        this.ctx.fillStyle = isJoint ? '#43e97b' : '#38f9d7';
                        this.ctx.beginPath();
                        this.ctx.arc(landmark.x * w, landmark.y * h, isJoint ? 8 : 5, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                });
            }

            calculateAngle(a, b, c) {
                const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
                let angle = Math.abs(radians * 180 / Math.PI);
                if (angle > 180) angle = 360 - angle;
                return Math.round(angle);
            }

            analyzePose(landmarks) {
                // Left elbow angle
                const leftElbow = this.calculateAngle(
                    landmarks[11], landmarks[13], landmarks[15]
                );
                document.getElementById('leftElbowAngle').textContent = leftElbow + '¬∞';

                // Right elbow angle
                const rightElbow = this.calculateAngle(
                    landmarks[12], landmarks[14], landmarks[16]
                );
                document.getElementById('rightElbowAngle').textContent = rightElbow + '¬∞';

                // Left knee angle
                const leftKnee = this.calculateAngle(
                    landmarks[23], landmarks[25], landmarks[27]
                );
                document.getElementById('leftKneeAngle').textContent = leftKnee + '¬∞';

                // Right knee angle
                const rightKnee = this.calculateAngle(
                    landmarks[24], landmarks[26], landmarks[28]
                );
                document.getElementById('rightKneeAngle').textContent = rightKnee + '¬∞';

                // Shoulder tilt
                const shoulderTilt = Math.round(
                    Math.atan2(landmarks[12].y - landmarks[11].y, landmarks[12].x - landmarks[11].x) * 180 / Math.PI
                );
                document.getElementById('shoulderTilt').textContent = shoulderTilt + '¬∞';
            }

            trackExercise(landmarks) {
                switch (this.currentExercise) {
                    case 'squat':
                        this.trackSquat(landmarks);
                        break;
                    case 'pushup':
                        this.trackPushup(landmarks);
                        break;
                    case 'jumpingjack':
                        this.trackJumpingJack(landmarks);
                        break;
                    case 'lunge':
                        this.trackLunge(landmarks);
                        break;
                }
            }

            trackSquat(landmarks) {
                const leftKnee = this.calculateAngle(landmarks[23], landmarks[25], landmarks[27]);
                const rightKnee = this.calculateAngle(landmarks[24], landmarks[26], landmarks[28]);
                const avgKnee = (leftKnee + rightKnee) / 2;

                const stateEl = document.getElementById('exerciseState');

                if (avgKnee < 100 && this.exerciseState === 'up') {
                    this.exerciseState = 'down';
                    stateEl.textContent = '‚¨áÔ∏è ÎÇ¥Î†§Í∞ê';
                    stateEl.style.background = 'rgba(254, 202, 87, 0.3)';
                } else if (avgKnee > 160 && this.exerciseState === 'down') {
                    this.exerciseState = 'up';
                    this.repCount++;
                    document.getElementById('repCount').textContent = this.repCount;
                    stateEl.textContent = '‚¨ÜÔ∏è Ïò¨ÎùºÍ∞ê';
                    stateEl.style.background = 'rgba(67, 233, 123, 0.3)';
                    this.showToast(`üéâ ${this.repCount}Ìöå!`);
                }
            }

            trackPushup(landmarks) {
                const leftElbow = this.calculateAngle(landmarks[11], landmarks[13], landmarks[15]);
                const rightElbow = this.calculateAngle(landmarks[12], landmarks[14], landmarks[16]);
                const avgElbow = (leftElbow + rightElbow) / 2;

                const stateEl = document.getElementById('exerciseState');

                if (avgElbow < 90 && this.exerciseState === 'up') {
                    this.exerciseState = 'down';
                    stateEl.textContent = '‚¨áÔ∏è ÎÇ¥Î†§Í∞ê';
                } else if (avgElbow > 150 && this.exerciseState === 'down') {
                    this.exerciseState = 'up';
                    this.repCount++;
                    document.getElementById('repCount').textContent = this.repCount;
                    stateEl.textContent = '‚¨ÜÔ∏è Ïò¨ÎùºÍ∞ê';
                    this.showToast(`üí™ ${this.repCount}Ìöå!`);
                }
            }

            trackJumpingJack(landmarks) {
                // Check arm position
                const leftArmUp = landmarks[15].y < landmarks[11].y;
                const rightArmUp = landmarks[16].y < landmarks[12].y;
                const armsUp = leftArmUp && rightArmUp;

                // Check leg spread
                const hipWidth = Math.abs(landmarks[23].x - landmarks[24].x);
                const ankleWidth = Math.abs(landmarks[27].x - landmarks[28].x);
                const legsSpread = ankleWidth > hipWidth * 1.5;

                const stateEl = document.getElementById('exerciseState');

                if (armsUp && legsSpread && this.exerciseState === 'down') {
                    this.exerciseState = 'up';
                    stateEl.textContent = '‚≠ê Ï†êÌîÑ!';
                } else if (!armsUp && !legsSpread && this.exerciseState === 'up') {
                    this.exerciseState = 'down';
                    this.repCount++;
                    document.getElementById('repCount').textContent = this.repCount;
                    stateEl.textContent = 'üßç Ï∞©ÏßÄ';
                    this.showToast(`‚≠ê ${this.repCount}Ìöå!`);
                }
            }

            trackLunge(landmarks) {
                const leftKnee = this.calculateAngle(landmarks[23], landmarks[25], landmarks[27]);
                const rightKnee = this.calculateAngle(landmarks[24], landmarks[26], landmarks[28]);

                const stateEl = document.getElementById('exerciseState');
                const inLunge = (leftKnee < 100 && rightKnee > 150) || (rightKnee < 100 && leftKnee > 150);

                if (inLunge && this.exerciseState === 'up') {
                    this.exerciseState = 'down';
                    stateEl.textContent = 'ü¶µ Îü∞ÏßÄ ÏûêÏÑ∏';
                } else if (!inLunge && leftKnee > 150 && rightKnee > 150 && this.exerciseState === 'down') {
                    this.exerciseState = 'up';
                    this.repCount++;
                    document.getElementById('repCount').textContent = this.repCount;
                    stateEl.textContent = 'üßç ÏÑúÍ∏∞';
                    this.showToast(`ü¶µ ${this.repCount}Ìöå!`);
                }
            }

            // Dance Game
            startDanceGame() {
                this.danceScore = 0;
                this.combo = 0;
                document.getElementById('danceScore').textContent = '0';
                document.getElementById('comboDisplay').textContent = '';

                this.spawnDanceTarget();
                this.danceInterval = setInterval(() => this.spawnDanceTarget(), 2000);
            }

            stopDanceGame() {
                if (this.danceInterval) {
                    clearInterval(this.danceInterval);
                    this.danceInterval = null;
                }
                document.getElementById('danceTargets').innerHTML = '';
                this.danceTargets = [];
            }

            spawnDanceTarget() {
                const targets = document.getElementById('danceTargets');
                const w = this.canvas.width;
                const h = this.canvas.height;

                // Random position
                const x = 100 + Math.random() * (w - 200);
                const y = 100 + Math.random() * (h - 300);

                // Random body part to hit
                const parts = ['leftHand', 'rightHand', 'leftFoot', 'rightFoot'];
                const part = parts[Math.floor(Math.random() * parts.length)];
                const emojis = { leftHand: 'üëã', rightHand: 'ü§ö', leftFoot: 'ü¶∂', rightFoot: 'üëü' };

                const target = document.createElement('div');
                target.className = 'dance-target';
                target.style.left = x + 'px';
                target.style.top = y + 'px';
                target.textContent = emojis[part];
                target.dataset.part = part;
                target.dataset.x = x;
                target.dataset.y = y;

                targets.appendChild(target);

                // Remove after 3 seconds if not hit
                setTimeout(() => {
                    if (target.parentNode) {
                        target.remove();
                        this.combo = 0;
                        document.getElementById('comboDisplay').textContent = '';
                    }
                }, 3000);

                this.danceTargets.push({ element: target, part, x, y });
            }

            updateDanceGame(landmarks) {
                const w = this.canvas.width;
                const h = this.canvas.height;

                // Body part positions
                const positions = {
                    leftHand: { x: landmarks[15].x * w, y: landmarks[15].y * h },
                    rightHand: { x: landmarks[16].x * w, y: landmarks[16].y * h },
                    leftFoot: { x: landmarks[27].x * w, y: landmarks[27].y * h },
                    rightFoot: { x: landmarks[28].x * w, y: landmarks[28].y * h }
                };

                this.danceTargets = this.danceTargets.filter(target => {
                    const pos = positions[target.part];
                    const dist = Math.sqrt(
                        Math.pow(pos.x - target.x - 40, 2) +
                        Math.pow(pos.y - target.y - 40, 2)
                    );

                    if (dist < 60) {
                        // Hit!
                        target.element.classList.add('hit');
                        setTimeout(() => target.element.remove(), 300);

                        this.combo++;
                        const points = 100 * this.combo;
                        this.danceScore += points;

                        document.getElementById('danceScore').textContent = this.danceScore;
                        document.getElementById('comboDisplay').textContent = this.combo > 1 ? `${this.combo}x COMBO!` : '';

                        this.showToast(`+${points}Ï†ê!`);
                        return false;
                    }

                    return target.element.parentNode !== null;
                });
            }

            initUI() {
                // Mode tabs
                document.querySelectorAll('.mode-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.currentMode = tab.dataset.mode;

                        // Toggle UI
                        document.getElementById('poseInfo').style.display = this.currentMode === 'analyze' ? 'block' : 'none';
                        document.getElementById('exerciseCounter').style.display = this.currentMode === 'exercise' ? 'block' : 'none';
                        document.getElementById('exerciseSelector').style.display = this.currentMode === 'exercise' ? 'flex' : 'none';
                        document.getElementById('scoreDisplay').style.display = this.currentMode === 'dance' ? 'block' : 'none';

                        // Stop/start dance game
                        if (this.currentMode === 'dance') {
                            this.startDanceGame();
                        } else {
                            this.stopDanceGame();
                        }
                    });
                });

                // Exercise selector
                document.querySelectorAll('.exercise-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.exercise-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentExercise = btn.dataset.exercise;
                        this.repCount = 0;
                        this.exerciseState = 'up';
                        document.getElementById('repCount').textContent = '0';
                        document.getElementById('exerciseName').textContent = btn.querySelector('.name').textContent;
                        document.getElementById('exerciseState').textContent = 'Ï§ÄÎπÑ';
                    });
                });

                // Capture
                document.getElementById('actionBtn').addEventListener('click', () => this.capture());

                // Reset
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.repCount = 0;
                    this.danceScore = 0;
                    this.combo = 0;
                    document.getElementById('repCount').textContent = '0';
                    document.getElementById('danceScore').textContent = '0';
                    document.getElementById('comboDisplay').textContent = '';
                    this.showToast('Î¶¨ÏÖã ÏôÑÎ£å!');
                });
            }

            capture() {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = this.canvas.width;
                tempCanvas.height = this.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');

                tempCtx.save();
                tempCtx.scale(-1, 1);
                tempCtx.drawImage(this.video, -tempCanvas.width, 0);
                tempCtx.restore();

                tempCtx.save();
                tempCtx.scale(-1, 1);
                tempCtx.drawImage(this.canvas, -tempCanvas.width, 0);
                tempCtx.restore();

                const link = document.createElement('a');
                link.download = `bodyplay_${Date.now()}.png`;
                link.href = tempCanvas.toDataURL();
                link.click();

                this.showToast('üì∏ Ï†ÄÏû•Îê®!');
            }

            showToast(msg) {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => new BodyPlayApp());
    </script>
</body>
</html>
